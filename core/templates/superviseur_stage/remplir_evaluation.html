{% extends "base.html" %}
{% load static %}

{% block title %}Remplir √âvaluation de Stage{% endblock %}

{% block content %}
{% if not user.is_authenticated %}
<div class="alert alert-danger">
    <strong>‚ùå Acc√®s refus√© :</strong> Vous devez √™tre connect√© pour acc√©der √† cette page.
    <a href="{% url 'login' %}?next={{ request.path }}">Se connecter</a>
</div>
{% elif not user.est_enseignant %}
<div class="alert alert-danger">
    <strong>‚ùå Acc√®s refus√© :</strong> Cette page est r√©serv√©e aux enseignants.
</div>
{% elif not user.est_superviseur_cec %}
<div class="alert alert-danger">
    <strong>‚ùå Acc√®s refus√© :</strong> Cette page est r√©serv√©e aux superviseurs cliniques et CEC. Veuillez contacter l'administration pour obtenir ce statut.
</div>
{% else %}
<div class="administration-container">
    <div class="page-header">
        <div class="header-top">
            <div>
                <h1>üìù Remplir l'√âvaluation de Stage</h1>
                <p class="subtitle">
                    √âtudiant : <strong>{{ evaluation.carnet.etudiant.get_full_name|default:evaluation.carnet.etudiant.username }}</strong> | 
                    Ann√©e : <strong>{{ evaluation.annee }}√®me ann√©e</strong>
                </p>
            </div>
            <a href="{% url 'liste_evaluations_superviseur' %}" class="btn-back">‚Üê Retour √† la liste</a>
        </div>
    </div>

    <div class="form-container">
        <form method="post" class="evaluation-form">
            {% csrf_token %}
            
            <!-- Informations du stage -->
            <div class="form-section">
                <h2>Informations du stage</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Type de stage</label>
                        <div class="form-control-static">{{ evaluation.get_type_stage_display }}</div>
                    </div>
                    <div class="form-group">
                        <label>Lieu du stage</label>
                        <div class="form-control-static">{{ evaluation.lieu_stage }}</div>
                    </div>
                    <div class="form-group">
                        <label>P√©riode</label>
                        <div class="form-control-static">
                            {{ evaluation.date_debut|date:"d/m/Y" }} - {{ evaluation.date_fin|date:"d/m/Y" }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- √âvaluation globale -->
            <div class="form-section">
                <h2>√âvaluation globale</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="{{ form.note_globale.id_for_label }}">{{ form.note_globale.label }}</label>
                        {{ form.note_globale }}
                        {% if form.note_globale.errors %}
                        <div class="error-message">{{ form.note_globale.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="form-group full-width">
                        <label for="{{ form.appreciation_globale.id_for_label }}">{{ form.appreciation_globale.label }}</label>
                        {{ form.appreciation_globale }}
                        {% if form.appreciation_globale.errors %}
                        <div class="error-message">{{ form.appreciation_globale.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="form-group full-width">
                        <label for="{{ form.points_forts.id_for_label }}">{{ form.points_forts.label }}</label>
                        {{ form.points_forts }}
                        {% if form.points_forts.errors %}
                        <div class="error-message">{{ form.points_forts.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="form-group full-width">
                        <label for="{{ form.points_amelioration.id_for_label }}">{{ form.points_amelioration.label }}</label>
                        {{ form.points_amelioration }}
                        {% if form.points_amelioration.errors %}
                        <div class="error-message">{{ form.points_amelioration.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- √âvaluations de comp√©tences -->
            <div class="form-section">
                <h2>√âvaluations de comp√©tences</h2>
                {% if evaluations_competences %}
                <div class="competences-list">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Comp√©tence</th>
                                <th>Jalon</th>
                                <th>Niveau d'acquisition</th>
                                <th>Commentaire</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for eval_comp in evaluations_competences %}
                            <tr>
                                <td>{{ eval_comp.competence.libelle }}</td>
                                <td>{% if eval_comp.jalon %}{{ eval_comp.jalon.nom }}{% else %}-{% endif %}</td>
                                <td>
                                    {% if eval_comp.niveau_acquisition %}
                                        <span class="badge badge-info">{{ eval_comp.get_niveau_acquisition_display }}</span>
                                    {% else %}
                                        <span class="badge badge-warning">Non √©valu√©</span>
                                    {% endif %}
                                </td>
                                <td>{{ eval_comp.commentaire|default:"-"|truncatewords:10 }}</td>
                                <td>
                                    <a href="{% url 'ajouter_evaluation_competence_superviseur' evaluation.id %}?competence={{ eval_comp.competence.id }}" class="btn-sm">Modifier</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="no-data">Aucune comp√©tence √©valu√©e pour ce stage.</p>
                {% endif %}
                
                {% if competences %}
                <div class="actions-section">
                    <a href="{% url 'ajouter_evaluation_competence_superviseur' evaluation.id %}" class="btn-primary">‚ûï Ajouter une √©valuation de comp√©tence</a>
                </div>
                {% endif %}
            </div>

            <!-- Boutons d'action -->
            <div class="form-actions">
                <button type="submit" class="btn-primary">üíæ Enregistrer l'√©valuation</button>
                <a href="{% url 'liste_evaluations_superviseur' %}" class="btn-secondary">Annuler</a>
            </div>
        </form>
    </div>
</div>

{% block extra_css %}
<style>
.form-container {
    background: white;
    padding: 2rem;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.form-section {
    margin-bottom: 2rem;
    padding-bottom: 2rem;
    border-bottom: 1px solid #eee;
}

.form-section:last-child {
    border-bottom: none;
}

.form-section h2 {
    color: #005a9c;
    margin-bottom: 1.5rem;
    font-size: 1.5rem;
}

.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group.full-width {
    grid-column: 1 / -1;
}

.form-group label {
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: #333;
}

.form-control-static {
    padding: 0.75rem;
    background: #f8f9fa;
    border-radius: 5px;
    color: #666;
}

.form-actions {
    display: flex;
    gap: 1rem;
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 2px solid #005a9c;
}

.competences-list {
    margin-top: 1rem;
}

.btn-secondary {
    padding: 0.75rem 1.5rem;
    background: #6c757d;
    color: white;
    text-decoration: none;
    border-radius: 5px;
    transition: background 0.3s;
}

.btn-secondary:hover {
    background: #5a6268;
}

.alert-danger {
    background-color: #f8d7da;
    border-color: #dc3545;
    color: #721c24;
    padding: 1rem 1.5rem;
    border-radius: 8px;
    margin-bottom: 2rem;
    border-left: 4px solid #dc3545;
}
</style>
{% endblock %}
{% endif %}
{% endblock %}

